<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Empreendimento - Studio 57</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="page-wrapper">
        <div id="sidebar-placeholder"></div>

        <div class="main-content-area-wrapper">
            <header class="main-header">
                <button id="sidebar-toggle-btn" class="sidebar-toggle-btn" title="Recolher/Expandir Menu"><i class="fas fa-bars"></i></button>
                <h1 id="page-title-header">Cadastro de Empreendimento</h1>
                <div class="header-user-info">
                    <div id="user-info">Usuário: <span class="font-semibold">Carregando...</span></div>
                    <div id="current-datetime">--/--/---- --:--:--</div>
                    <button id="logout-button-header" title="Sair"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </header>
            
            <main class="content-scrollable">
                <div class="toast-container" id="toastContainer"></div>
                <div class="form-container">
                    <form id="empreendimentoForm" class="form-body">
                        <div class="form-section">
                            <h3 class="form-section-title">1. Identificação do Empreendimento</h3>
                            <div class="form-grid-1-col">
                                <div class="form-group">
                                    <label for="nomeEmpreendimento" class="form-label">Nome do Empreendimento</label>
                                    <input type="text" id="nomeEmpreendimento" class="form-control" required>
                                </div>
                            </div>
                            <div class="form-grid-2-col">
                                <div class="form-group">
                                    <label for="usoImovel" class="form-label">Uso do Imóvel</label>
                                    <input type="text" id="usoImovel" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="descricaoProjeto" class="form-label">Descrição Sintética do Projeto</label>
                                    <input type="text" id="descricaoProjeto" class="form-control">
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3 class="form-section-title">2. Endereço do Imóvel</h3>
                            <div class="form-grid-3-col">
                                <div class="form-group">
                                    <label for="cep" class="form-label">CEP</label>
                                    <input type="text" id="cep" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="logradouro" class="form-label">Logradouro</label>
                                    <input type="text" id="logradouro" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="numero" class="form-label">Número</label>
                                    <input type="text" id="numero" class="form-control">
                                </div>
                            </div>
                            <div class="form-grid-3-col">
                                <div class="form-group">
                                    <label for="bairro" class="form-label">Bairro</label>
                                    <input type="text" id="bairro" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="cidade" class="form-label">Cidade</label>
                                    <input type="text" id="cidade" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="estado" class="form-label">Estado</label>
                                    <input type="text" id="estado" class="form-control">
                                </div>
                            </div>
                            <div class="form-grid-4-col">
                                <div class="form-group">
                                    <label for="lote" class="form-label">Lote</label>
                                    <input type="text" id="lote" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="quadra" class="form-label">Quadra</label>
                                    <input type="text" id="quadra" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="zona" class="form-label">Zona</label>
                                    <input type="text" id="zona" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="via" class="form-label">Via</label>
                                    <input type="text" id="via" class="form-control">
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3 class="form-section-title">3. Informações Adicionais</h3>
                            <div class="form-grid-2-col">
                                <div class="form-group">
                                    <label for="areaTerreno" class="form-label">Área do Terreno (m²)</label>
                                    <input type="number" id="areaTerreno" class="form-control" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label for="proprietarioNome" class="form-label">Nome do Proprietário</label>
                                    <input type="text" id="proprietarioNome" class="form-control">
                                </div>
                            </div>
                             <div class="form-grid-2-col">
                                <div class="form-group">
                                    <label for="proprietarioCpfCnpj" class="form-label">CPF/CNPJ do Proprietário</label>
                                    <input type="text" id="proprietarioCpfCnpj" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="responsavelTecnicoNome" class="form-label">Responsável Técnico</label>
                                    <input type="text" id="responsavelTecnicoNome" class="form-control">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="cauCrea" class="form-label">CAU/CREA</label>
                                <input type="text" id="cauCrea" class="form-control">
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary-form">Salvar Empreendimento</button>
                        </div>
                    </form>
                </div>
                 <div class="loading-overlay" id="loadingSpinner" style="display: none;">
                    <div class="spinner"></div>
                </div>
            </main>
        </div>
    </div>
    
    <script type="module">
        import { supabaseClient as supabase } from './js/supabase-config.js';
        import { checkAuthAndRedirect, initializeCommonUI, loadHTMLComponent, initializeSidebarToggle, showLoading, hideLoading, showToast } from './js/common.js';

        // --- INICIALIZAÇÃO DA PÁGINA ---
        async function initializePage() {
            await loadHTMLComponent('sidebar-placeholder', 'sidebar.html');
            checkAuthAndRedirect((user) => {
                initializeCommonUI(user);
                initializeSidebarToggle();
            });
        }
        initializePage();

        // --- LÓGICA DO FORMULÁRIO ---
        const form = document.getElementById('empreendimentoForm');
        const cepInput = document.getElementById('cep');

        // Função para buscar endereço pelo CEP
        cepInput.addEventListener('blur', async () => {
            const cep = cepInput.value.replace(/\D/g, '');
            if (cep.length !== 8) return;

            showLoading();
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                if (!response.ok) throw new Error('CEP não encontrado');
                const data = await response.json();
                if (data.erro) throw new Error('CEP inválido');
                
                document.getElementById('logradouro').value = data.logradouro;
                document.getElementById('bairro').value = data.bairro;
                document.getElementById('cidade').value = data.localidade;
                document.getElementById('estado').value = data.uf;
            } catch (error) {
                console.error("Erro ao buscar CEP:", error);
                showToast('error', 'Erro de CEP', error.message);
            } finally {
                hideLoading();
            }
        });

        // Função para salvar o formulário
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();

            const empreendimentoData = {
                nomeEmpreendimento: document.getElementById('nomeEmpreendimento').value,
                usoImovel: document.getElementById('usoImovel').value,
                descricaoProjeto: document.getElementById('descricaoProjeto').value,
                cep: document.getElementById('cep').value,
                logradouro: document.getElementById('logradouro').value,
                numero: document.getElementById('numero').value,
                bairro: document.getElementById('bairro').value,
                cidade: document.getElementById('cidade').value,
                estado: document.getElementById('estado').value,
                lote: document.getElementById('lote').value,
                quadra: document.getElementById('quadra').value,
                zona: document.getElementById('zona').value,
                via: document.getElementById('via').value,
                areaTerreno: parseFloat(document.getElementById('areaTerreno').value) || null,
                proprietarioNome: document.getElementById('proprietarioNome').value,
                proprietarioCpfCnpj: document.getElementById('proprietarioCpfCnpj').value,
                responsavelTecnicoNome: document.getElementById('responsavelTecnicoNome').value,
                cauCrea: document.getElementById('cauCrea').value,
                criadoEm: new Date().toISOString() // Data de criação
            };

            try {
                const { data, error } = await supabase
                    .from('empreendimentos')
                    .insert([empreendimentoData]);

                if (error) {
                    throw error;
                }

                showToast('success', 'Sucesso!', 'Empreendimento cadastrado com sucesso.');
                form.reset();
            } catch (error) {
                console.error("Erro ao salvar empreendimento:", error);
                showToast('error', 'Erro ao Salvar', 'Não foi possível cadastrar o empreendimento.');
            } finally {
                hideLoading();
            }
        });
    </script>
</body>
</html>