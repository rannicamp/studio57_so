<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Funcionário - Studio 57</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="page-wrapper">
        <div id="sidebar-placeholder"></div>

        <div class="main-content-area-wrapper">
            <header class="main-header">
                <button id="sidebar-toggle-btn" class="sidebar-toggle-btn" title="Recolher/Expandir Menu"><i class="fas fa-bars"></i></button>
                <h1 id="page-title-header">Cadastro de Funcionário</h1>
                <div class="header-user-info">
                    <div id="user-info">Usuário: <span class="font-semibold">Carregando...</span></div>
                    <div id="current-datetime">--/--/---- --:--:--</div>
                    <button id="logout-button-header" title="Sair"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </header>
            
            <main class="content-scrollable">
                <div class="toast-container" id="toastContainer"></div>
                <div class="form-container">
                    <form id="funcionarioForm" class="form-body">
                        <div class="form-section">
                            <h3 class="form-section-title">1. Dados Pessoais</h3>
                            <div class="form-grid-1-col">
                                <div class="form-group">
                                    <label for="nomeCompleto" class="form-label">Nome Completo</label>
                                    <input type="text" id="nomeCompleto" class="form-control" required>
                                </div>
                            </div>
                            <div class="form-grid-2-col">
                                <div class="form-group">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" id="email" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="telefone" class="form-label">Telefone</label>
                                    <input type="tel" id="telefone" class="form-control">
                                </div>
                            </div>
                            <div class="form-grid-3-col">
                                <div class="form-group">
                                    <label for="cpf" class="form-label">CPF</label>
                                    <input type="text" id="cpf" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="rg" class="form-label">RG</label>
                                    <input type="text" id="rg" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="dataNascimento" class="form-label">Data de Nascimento</label>
                                    <input type="date" id="dataNascimento" class="form-control">
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3 class="form-section-title">2. Endereço</h3>
                             <div class="form-grid-3-col">
                                <div class="form-group">
                                    <label for="cep" class="form-label">CEP</label>
                                    <input type="text" id="cep" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="logradouro" class="form-label">Logradouro</label>
                                    <input type="text" id="logradouro" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="numero" class="form-label">Número</label>
                                    <input type="text" id="numero" class="form-control">
                                </div>
                            </div>
                            <div class="form-grid-2-col">
                                <div class="form-group">
                                    <label for="complemento" class="form-label">Complemento</label>
                                    <input type="text" id="complemento" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="bairro" class="form-label">Bairro</label>
                                    <input type="text" id="bairro" class="form-control">
                                </div>
                            </div>
                            <div class="form-grid-2-col">
                                <div class="form-group">
                                    <label for="cidade" class="form-label">Cidade</label>
                                    <input type="text" id="cidade" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="estado" class="form-label">Estado</label>
                                    <input type="text" id="estado" class="form-control">
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3 class="form-section-title">3. Dados Contratuais</h3>
                            <div class="form-grid-3-col">
                                <div class="form-group">
                                    <label for="cargo" class="form-label">Cargo/Função</label>
                                    <input type="text" id="cargo" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="dataAdmissao" class="form-label">Data de Admissão</label>
                                    <input type="date" id="dataAdmissao" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="idRelogioPonto" class="form-label">ID Relógio de Ponto</label>
                                    <input type="text" id="idRelogioPonto" class="form-control">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="empreendimentoId" class="form-label">Alocar em</label>
                                <select id="empreendimentoId" class="form-control">
                                    <option value="">Nenhum</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3 class="form-section-title">4. Dados Financeiros</h3>
                            <div class="form-grid-3-col">
                                <div class="form-group">
                                    <label for="formaPagamento" class="form-label">Forma de Pagamento</label>
                                    <select id="formaPagamento" class="form-control">
                                        <option value="pix">PIX</option>
                                        <option value="transferencia">Transferência Bancária</option>
                                        <option value="especie">Em Espécie</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="chavePix" class="form-label">Chave PIX</label>
                                    <input type="text" id="chavePix" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="dadosBancarios" class="form-label">Dados Bancários</label>
                                    <textarea id="dadosBancarios" class="form-control" rows="2"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3 class="form-section-title">5. Documentos</h3>
                            <div class="form-grid-2-col">
                                <div class="form-group">
                                    <label for="fotoFuncionario" class="form-label">Foto do Funcionário</label>
                                    <input type="file" id="fotoFuncionario" class="form-control-file">
                                </div>
                                <div class="form-group">
                                    <label for="contratoFuncionario" class="form-label">Contrato de Trabalho</label>
                                    <input type="file" id="contratoFuncionario" class="form-control-file">
                                </div>
                            </div>
                            <div class="form-grid-2-col">
                                <div class="form-group">
                                    <label for="identidadeFuncionario" class="form-label">Documento de Identidade</label>
                                    <input type="file" id="identidadeFuncionario" class="form-control-file">
                                </div>
                                <div class="form-group">
                                    <label for="asoFuncionario" class="form-label">ASO (Atestado de Saúde)</label>
                                    <input type="file" id="asoFuncionario" class="form-control-file">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary-form">Salvar Funcionário</button>
                        </div>
                    </form>
                </div>

                 <div class="loading-overlay" id="loadingSpinner" style="display: none;">
                    <div class="spinner"></div>
                </div>
            </main>
        </div>
    </div>
    
    <script type="module">
        import { supabaseClient as supabase } from './js/supabase-config.js';
        import { checkAuthAndRedirect, initializeCommonUI, loadHTMLComponent, initializeSidebarToggle, showLoading, hideLoading, showToast } from './js/common.js';

        // --- INICIALIZAÇÃO DA PÁGINA ---
        async function initializePage() {
            await loadHTMLComponent('sidebar-placeholder', 'sidebar.html');
            checkAuthAndRedirect((user) => {
                initializeCommonUI(user);
                initializeSidebarToggle();
                loadEmpreendimentos();
            });
        }
        initializePage();

        // --- LÓGICA DO FORMULÁRIO ---
        const form = document.getElementById('funcionarioForm');
        const cepInput = document.getElementById('cep');

        // Função para carregar empreendimentos no select
        async function loadEmpreendimentos() {
            const { data, error } = await supabase.from('empreendimentos').select('id, nomeEmpreendimento');
            if (error) {
                console.error('Erro ao buscar empreendimentos:', error);
                return;
            }
            const select = document.getElementById('empreendimentoId');
            data.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = emp.nomeEmpreendimento;
                option.dataset.nome = emp.nomeEmpreendimento;
                select.appendChild(option);
            });
        }

        // Função para buscar endereço pelo CEP
        cepInput.addEventListener('blur', async () => {
            const cep = cepInput.value.replace(/\D/g, '');
            if (cep.length !== 8) return;
            showLoading();
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                if (!response.ok) throw new Error('CEP não encontrado');
                const data = await response.json();
                if (data.erro) throw new Error('CEP inválido');
                
                document.getElementById('logradouro').value = data.logradouro;
                document.getElementById('bairro').value = data.bairro;
                document.getElementById('cidade').value = data.localidade;
                document.getElementById('estado').value = data.uf;
            } catch (error) {
                console.error("Erro ao buscar CEP:", error);
                showToast('error', 'Erro de CEP', error.message);
            } finally {
                hideLoading();
            }
        });
        
        // Função para fazer upload de um único arquivo para o Supabase Storage
        async function uploadSingleFile(fileInput, cpf) {
            if (!fileInput.files || fileInput.files.length === 0) {
                return { url: null, path: null };
            }
            const file = fileInput.files[0];
            const fileExt = file.name.split('.').pop();
            const fileName = `${cpf}-${fileInput.id}-${Date.now()}.${fileExt}`;
            const filePath = `${cpf}/${fileName}`;

            const { error: uploadError } = await supabase.storage
                .from('documentosfuncionarios') // NOME CORRIGIDO
                .upload(filePath, file);

            if (uploadError) {
                throw new Error(`Falha no upload de ${fileInput.id}: ${uploadError.message}`);
            }

            const { data: { publicUrl } } = supabase.storage
                .from('documentosfuncionarios') // NOME CORRIGIDO
                .getPublicUrl(filePath);
            
            return { url: publicUrl, path: filePath };
        }

        // Função para salvar o formulário
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();

            const cpf = document.getElementById('cpf').value.replace(/\D/g, '');
            if (!cpf) {
                showToast('error', 'CPF Obrigatório', 'O CPF é necessário para criar a pasta de documentos.');
                hideLoading();
                return;
            }
            
            try {
                // Upload dos arquivos em paralelo
                const [
                    fotoData, 
                    contratoData, 
                    identidadeData, 
                    asoData
                ] = await Promise.all([
                    uploadSingleFile(document.getElementById('fotoFuncionario'), cpf),
                    uploadSingleFile(document.getElementById('contratoFuncionario'), cpf),
                    uploadSingleFile(document.getElementById('identidadeFuncionario'), cpf),
                    uploadSingleFile(document.getElementById('asoFuncionario'), cpf)
                ]);

                // Monta o objeto com os dados do funcionário
                const selectEmpreendimento = document.getElementById('empreendimentoId');
                const selectedOption = selectEmpreendimento.options[selectEmpreendimento.selectedIndex];

                const funcionarioData = {
                    nomeCompleto: document.getElementById('nomeCompleto').value,
                    email: document.getElementById('email').value,
                    cpf: document.getElementById('cpf').value,
                    rg: document.getElementById('rg').value,
                    dataNascimento: document.getElementById('dataNascimento').value || null,
                    telefone: document.getElementById('telefone').value,
                    cep: document.getElementById('cep').value,
                    logradouro: document.getElementById('logradouro').value,
                    numero: document.getElementById('numero').value,
                    complemento: document.getElementById('complemento').value,
                    bairro: document.getElementById('bairro').value,
                    cidade: document.getElementById('cidade').value,
                    estado: document.getElementById('estado').value,
                    cargo: document.getElementById('cargo').value,
                    dataAdmissao: document.getElementById('dataAdmissao').value,
                    idRelogioPonto: document.getElementById('idRelogioPonto').value,
                    empreendimentoId: selectedOption.value || null,
                    empreendimentoNome: selectedOption.dataset.nome || null,
                    formaPagamento: document.getElementById('formaPagamento').value,
                    chavePix: document.getElementById('chavePix').value,
                    dadosBancarios: document.getElementById('dadosBancarios').value,
                    
                    fotoFuncionarioUrl: fotoData.url,
                    fotoFuncionarioPath: fotoData.path,
                    contratoFuncionarioUrl: contratoData.url,
                    contratoFuncionarioPath: contratoData.path,
                    identidadeFuncionarioUrl: identidadeData.url,
                    identidadeFuncionarioPath: identidadeData.path,
                    asoFuncionarioUrl: asoData.url,
                    asoFuncionarioPath: asoData.path,
                };
                
                // Insere os dados no banco de dados Supabase
                const { error } = await supabase.from('funcionario').insert([funcionarioData]);

                if (error) throw error;
                
                showToast('success', 'Sucesso!', 'Funcionário cadastrado com sucesso.');
                form.reset();

            } catch (error) {
                console.error("Erro ao salvar funcionário:", error);
                showToast('error', 'Erro ao Salvar', `Não foi possível cadastrar o funcionário. Detalhes: ${error.message}`);
            } finally {
                hideLoading();
            }
        });
    </script>
</body>
</html>