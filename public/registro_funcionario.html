<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Funcionário - Studio 57</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="page-wrapper">
        <div id="sidebar-placeholder"></div>

        <div class="main-content-area-wrapper">
            <header class="main-header">
                <button id="sidebar-toggle-btn" class="sidebar-toggle-btn" title="Recolher/Expandir Menu"><i class="fas fa-bars"></i></button>
                <h1 id="page-title-header">Cadastro de Funcionário</h1>
                <div class="header-user-info">
                    <div id="user-info">Usuário: <span class="font-semibold">Carregando...</span></div>
                    <div id="current-datetime">--/--/---- --:--:--</div>
                    <button id="logout-button-header" title="Sair"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </header>
            
            <main class="content-scrollable">
                <div class="toast-container" id="toastContainer"></div>
                <div class="form-container">
                    <form id="funcionarioForm" class="form-body">
                        <input type="hidden" id="funcionarioId">
                        
                        <div class="form-section">
                            <h3 class="form-section-title">1. Dados Pessoais</h3>
                            <div class="form-grid-1-col">
                                <div class="form-group">
                                    <label for="nomeCompleto" class="form-label">Nome Completo *</label>
                                    <input type="text" id="nomeCompleto" class="form-control" required>
                                </div>
                            </div>
                            <div class="form-grid-2-col">
                                <div class="form-group">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" id="email" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="telefone" class="form-label">Telefone</label>
                                    <input type="tel" id="telefone" class="form-control">
                                </div>
                            </div>
                            <div class="form-grid-3-col">
                                <div class="form-group">
                                    <label for="cpf" class="form-label">CPF *</label>
                                    <input type="text" id="cpf" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="rg" class="form-label">RG</label>
                                    <input type="text" id="rg" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="dataNascimento" class="form-label">Data de Nascimento</label>
                                    <input type="date" id="dataNascimento" class="form-control">
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3 class="form-section-title">2. Endereço</h3>
                             <div class="form-grid-3-col">
                                <div class="form-group">
                                    <label for="cep" class="form-label">CEP</label>
                                    <input type="text" id="cep" class="form-control" maxlength="9">
                                </div>
                                <div class="form-group">
                                    <label for="logradouro" class="form-label">Logradouro</label>
                                    <input type="text" id="logradouro" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="numero" class="form-label">Número</label>
                                    <input type="text" id="numero" class="form-control">
                                </div>
                            </div>
                            <div class="form-grid-2-col">
                                <div class="form-group">
                                    <label for="complemento" class="form-label">Complemento</label>
                                    <input type="text" id="complemento" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="bairro" class="form-label">Bairro</label>
                                    <input type="text" id="bairro" class="form-control">
                                </div>
                            </div>
                            <div class="form-grid-2-col">
                                <div class="form-group">
                                    <label for="cidade" class="form-label">Cidade</label>
                                    <input type="text" id="cidade" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="estado" class="form-label">Estado</label>
                                    <input type="text" id="estado" class="form-control">
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3 class="form-section-title">3. Dados Contratuais</h3>
                            <div class="form-grid-3-col">
                                <div class="form-group">
                                    <label for="cargo" class="form-label">Cargo/Função *</label>
                                    <input type="text" id="cargo" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="dataAdmissao" class="form-label">Data de Admissão *</label>
                                    <input type="date" id="dataAdmissao" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="idRelogioPonto" class="form-label">ID Relógio de Ponto</label>
                                    <input type="text" id="idRelogioPonto" class="form-control">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="empreendimentoId" class="form-label">Alocar em</label>
                                <select id="empreendimentoId" class="form-control">
                                    <option value="">Nenhum</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3 class="form-section-title">4. Dados Financeiros</h3>
                            <div class="form-grid-3-col">
                                <div class="form-group">
                                    <label for="formaPagamento" class="form-label">Forma de Pagamento</label>
                                    <select id="formaPagamento" class="form-control">
                                        <option value="pix">PIX</option>
                                        <option value="transferencia">Transferência Bancária</option>
                                        <option value="especie">Em Espécie</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="chavePix" class="form-label">Chave PIX</label>
                                    <input type="text" id="chavePix" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="dadosBancarios" class="form-label">Dados Bancários</label>
                                    <textarea id="dadosBancarios" class="form-control" rows="2" placeholder="Banco, Agência, Conta"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3 class="form-section-title">5. Documentos</h3>
                            <p class="form-subtitle" style="margin-top: -1rem; margin-bottom: 1rem;">Envie um novo arquivo apenas se quiser substituir o atual.</p>
                            <div class="form-grid-2-col">
                                <div class="form-group">
                                    <label for="fotoFuncionario" class="form-label">Foto do Funcionário</label>
                                    <input type="file" id="fotoFuncionario" class="form-control-file" accept="image/*">
                                </div>
                                <div class="form-group">
                                    <label for="contratoFuncionario" class="form-label">Contrato de Trabalho</label>
                                    <input type="file" id="contratoFuncionario" class="form-control-file" accept=".pdf,.doc,.docx">
                                </div>
                            </div>
                            <div class="form-grid-2-col">
                                <div class="form-group">
                                    <label for="identidadeFuncionario" class="form-label">Documento de Identidade</label>
                                    <input type="file" id="identidadeFuncionario" class="form-control-file" accept=".pdf,image/*">
                                </div>
                                <div class="form-group">
                                    <label for="asoFuncionario" class="form-label">ASO (Atestado de Saúde)</label>
                                    <input type="file" id="asoFuncionario" class="form-control-file" accept=".pdf,image/*">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary-form">Salvar Funcionário</button>
                             <button type="button" class="btn btn-outline-form" id="cancelButton">Cancelar</button>
                        </div>
                    </form>
                </div>

                 <div class="loading-overlay" id="loadingSpinner" style="display: none;">
                    <div class="spinner"></div>
                </div>
            </main>
        </div>
    </div>
    
    <script type="module">
        import { supabaseClient as supabase } from './js/supabase-config.js';
        import { checkAuthAndRedirect, initializeCommonUI, loadHTMLComponent, initializeSidebarToggle, showLoading, hideLoading, showToast } from './js/common.js';

        let editMode = false;
        let currentFuncionarioId = null;
        let existingFilePaths = {};

        // --- INICIALIZAÇÃO DA PÁGINA ---
        async function initializePage() {
            await loadHTMLComponent('sidebar-placeholder', 'sidebar.html');
            checkAuthAndRedirect(async (user) => {
                initializeCommonUI(user);
                initializeSidebarToggle();
                await loadEmpreendimentos(); // Aguarda os empreendimentos carregarem

                const urlParams = new URLSearchParams(window.location.search);
                currentFuncionarioId = urlParams.get('id');
                if (currentFuncionarioId) {
                    editMode = true;
                    document.getElementById('page-title-header').textContent = 'Editar Funcionário';
                    await loadFuncionarioData(currentFuncionarioId);
                }
            });
        }
        initializePage();

        // --- LÓGICA DO FORMULÁRIO ---
        const form = document.getElementById('funcionarioForm');
        const cepInput = document.getElementById('cep');

        async function loadEmpreendimentos() {
            const { data, error } = await supabase.from('empreendimentos').select('id, nomeEmpreendimento').order('nomeEmpreendimento');
            if (error) {
                console.error('Erro ao buscar empreendimentos:', error);
                return;
            }
            const select = document.getElementById('empreendimentoId');
            data.forEach(emp => {
                const option = new Option(emp.nomeEmpreendimento, emp.id);
                option.dataset.nome = emp.nomeEmpreendimento;
                select.add(option);
            });
        }

        async function loadFuncionarioData(id) {
            showLoading();
            const { data, error } = await supabase.from('funcionario').select('*').eq('id', id).single();
            hideLoading();
            if (error) {
                showToast('error', 'Erro', 'Não foi possível carregar os dados do funcionário.');
                return;
            }
            
            // Preenche o formulário com os dados
            Object.keys(data).forEach(key => {
                const input = document.getElementById(key);
                if (input) {
                    if (input.type === 'date' && data[key]) {
                        input.value = data[key];
                    } else {
                        input.value = data[key] || '';
                    }
                }
            });
            // Armazena os caminhos dos arquivos existentes para possível exclusão
            existingFilePaths = {
                fotoFuncionario: data.fotoFuncionarioPath,
                contratoFuncionario: data.contratoFuncionarioPath,
                identidadeFuncionario: data.identidadeFuncionarioPath,
                asoFuncionario: data.asoFuncionarioPath,
            };
        }

        cepInput.addEventListener('blur', async () => { /* ... (código do CEP como antes) ... */ });

        async function uploadSingleFile(fileInput, cpf, existingPath) {
            if (!fileInput.files || fileInput.files.length === 0) {
                return { url: null, path: null, uploaded: false };
            }
            const file = fileInput.files[0];
            const filePath = `${cpf}/${fileInput.id}-${Date.now()}.${file.name.split('.').pop()}`;

            // Se um arquivo novo foi enviado e um antigo existia, remove o antigo
            if(existingPath) {
                await supabase.storage.from('documentosfuncionarios').remove([existingPath]);
            }

            const { error: uploadError } = await supabase.storage.from('documentosfuncionarios').upload(filePath, file);
            if (uploadError) throw new Error(`Falha no upload de ${fileInput.id}: ${uploadError.message}`);
            
            const { data: { publicUrl } } = supabase.storage.from('documentosfuncionarios').getPublicUrl(filePath);
            return { url: publicUrl, path: filePath, uploaded: true };
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();

            const cpf = document.getElementById('cpf').value.replace(/\D/g, '');
            if (!cpf) {
                showToast('error', 'CPF Obrigatório', 'O CPF é necessário para organizar os documentos.');
                hideLoading();
                return;
            }
            
            try {
                const uploadPromises = [
                    uploadSingleFile(document.getElementById('fotoFuncionario'), cpf, existingFilePaths.fotoFuncionario),
                    uploadSingleFile(document.getElementById('contratoFuncionario'), cpf, existingFilePaths.contratoFuncionario),
                    uploadSingleFile(document.getElementById('identidadeFuncionario'), cpf, existingFilePaths.identidadeFuncionario),
                    uploadSingleFile(document.getElementById('asoFuncionario'), cpf, existingFilePaths.asoFuncionario)
                ];
                const [fotoData, contratoData, identidadeData, asoData] = await Promise.all(uploadPromises);

                const selectEmpreendimento = document.getElementById('empreendimentoId');
                const selectedOption = selectEmpreendimento.options[selectEmpreendimento.selectedIndex];

                const funcionarioData = {
                    nomeCompleto: document.getElementById('nomeCompleto').value,
                    email: document.getElementById('email').value,
                    cpf: document.getElementById('cpf').value,
                    rg: document.getElementById('rg').value,
                    dataNascimento: document.getElementById('dataNascimento').value || null,
                    telefone: document.getElementById('telefone').value,
                    cep: document.getElementById('cep').value,
                    logradouro: document.getElementById('logradouro').value,
                    numero: document.getElementById('numero').value,
                    complemento: document.getElementById('complemento').value,
                    bairro: document.getElementById('bairro').value,
                    cidade: document.getElementById('cidade').value,
                    estado: document.getElementById('estado').value,
                    cargo: document.getElementById('cargo').value,
                    dataAdmissao: document.getElementById('dataAdmissao').value,
                    idRelogioPonto: document.getElementById('idRelogioPonto').value,
                    empreendimentoId: selectedOption.value || null,
                    empreendimentoNome: selectedOption.dataset.nome || null,
                    formaPagamento: document.getElementById('formaPagamento').value,
                    chavePix: document.getElementById('chavePix').value,
                    dadosBancarios: document.getElementById('dadosBancarios').value,
                };
                
                // Atualiza URLs e Paths somente se um novo arquivo foi enviado
                if (fotoData.uploaded) {
                    funcionarioData.fotoFuncionarioUrl = fotoData.url;
                    funcionarioData.fotoFuncionarioPath = fotoData.path;
                }
                if (contratoData.uploaded) {
                    funcionarioData.contratoFuncionarioUrl = contratoData.url;
                    funcionarioData.contratoFuncionarioPath = contratoData.path;
                }
                if (identidadeData.uploaded) {
                    funcionarioData.identidadeFuncionarioUrl = identidadeData.url;
                    funcionarioData.identidadeFuncionarioPath = identidadeData.path;
                }
                if (asoData.uploaded) {
                    funcionarioData.asoFuncionarioUrl = asoData.url;
                    funcionarioData.asoFuncionarioPath = asoData.path;
                }
                
                let error;
                if(editMode) {
                    ({ error } = await supabase.from('funcionario').update(funcionarioData).eq('id', currentFuncionarioId));
                } else {
                    ({ error } = await supabase.from('funcionario').insert([funcionarioData]));
                }

                if (error) throw error;
                
                showToast('success', 'Sucesso!', `Funcionário ${editMode ? 'atualizado' : 'cadastrado'} com sucesso.`);
                if (editMode) {
                    window.location.href = 'quadro_de_funcionarios.html';
                } else {
                    form.reset();
                }

            } catch (error) {
                console.error("Erro ao salvar funcionário:", error);
                showToast('error', 'Erro ao Salvar', `Não foi possível salvar o funcionário. Detalhes: ${error.message}`);
            } finally {
                hideLoading();
            }
        });

        document.getElementById('cancelButton')?.addEventListener('click', () => {
             if (confirm('Tem certeza que deseja cancelar? Todas as alterações não salvas serão perdidas.')) {
                 window.location.href = 'quadro_de_funcionarios.html';
             }
        });
    </script>
</body>
</html>